import{_ as M,b as G,a as j,h as $}from"./index-abfa6c99.js";import{U as q}from"./useLayout-7717c0e7.js";import{r as g,o as m,c as I,a as r,w as _,j as F,t as U,m as C,d as p,S as N,y as V,I as B,i as A,Z as Y,A as S,k as O,X as T,_ as z,F as D,$ as X,n as Z,l as H,p as J,b as K,O as Q}from"./vendor-9b0cf635.js";import{U as W}from"./UiButton-e852b53f.js";import{U as k,a as R}from"./UiInput-35031c5c.js";import{d as x,t as ee,e as te}from"./meetupService-6ba15c28.js";import{u as E}from"./useApi-f4bc375e.js";import{p as oe,c as ne}from"./meetupsApi-100c656f.js";const ae={name:"LayoutMeetupForm",components:{UiPageTitle:q,UiContainer:G},props:{title:String}},le={class:"page-meetup-form"};function se(e,t,n,u,o,a){const l=g("UiPageTitle"),d=g("UiContainer");return m(),I("div",le,[r(d,null,{default:_(()=>[r(l,null,{default:_(()=>[F(U(n.title),1)]),_:1}),C(e.$slots,"default",{},void 0,!0)]),_:3})])}const Xe=M(ae,[["render",se],["__scopeId","data-v-d9c7a9fa"],["__file","LayoutMeetupForm.vue"]]);function v(e){if(typeof e!="object")return e;var t,n,u=Object.prototype.toString.call(e);if(u==="[object Object]"){if(e.constructor!==Object&&typeof e.constructor=="function"){n=new e.constructor;for(t in e)e.hasOwnProperty(t)&&n[t]!==e[t]&&(n[t]=v(e[t]))}else{n={};for(t in e)t==="__proto__"?Object.defineProperty(n,t,{value:v(e[t]),configurable:!0,enumerable:!0,writable:!0}):n[t]=v(e[t])}return n}if(u==="[object Array]"){for(t=e.length,n=Array(t);t--;)n[t]=v(e[t]);return n}return u==="[object Set]"?(n=new Set,e.forEach(function(o){n.add(v(o))}),n):u==="[object Map]"?(n=new Map,e.forEach(function(o,a){n.set(v(a),v(o))}),n):u==="[object Date]"?new Date(+e):u==="[object RegExp]"?(n=new RegExp(e.source,e.flags),n.lastIndex=e.lastIndex,n):u==="[object DataView]"?new e.constructor(v(e.buffer)):u==="[object ArrayBuffer]"?e.slice(0):u.slice(-6)==="Array]"?new e.constructor(e):e}const f={EMPTY:"EMPTY",LOADING:"LOADING",FILLED:"FILLED"},re={name:"UiImageUploader",inheritAttrs:!1,States:f,props:{uploader:{type:Function},preview:{type:String}},emits:["upload","select","error","remove"],data(){return{state:this.preview?f.FILLED:f.EMPTY,localPreview:null}},computed:{stateText(){return{[f.EMPTY]:"Загрузить изображение",[f.LOADING]:"Загрузка...",[f.FILLED]:"Удалить изображение"}[this.state]},imageSrc(){return this.localPreview??this.preview}},beforeUnmount(){this.localPreview&&URL.revokeObjectURL(this.localPreview)},methods:{async handleFileSelect(e){const t=e.target.files[0];if(this.$emit("select",t),this.localPreview=URL.createObjectURL(t),!this.uploader){this.state=f.FILLED;return}return await this.upload(t)},async upload(e){this.state=f.LOADING;try{const t=await this.uploader(e);this.$emit("upload",t),this.state=f.FILLED}catch(t){this.$emit("error",t),this.state=f.EMPTY,this.removeFile()}},handleClick(e){this.state===f.LOADING?e.preventDefault():this.state===f.FILLED&&(e.preventDefault(),this.removeFile(),this.state=f.EMPTY,this.$emit("remove"))},removeFile(){this.$refs.input.value="",this.localPreview=null}}},ie={class:"image-uploader"},ue={class:"image-uploader__text"};function de(e,t,n,u,o,a){return m(),I("div",ie,[p("label",{class:V(["image-uploader__preview",{"image-uploader__preview-loading":o.state===e.$options.States.LOADING}]),style:B(o.state!==e.$options.States.EMPTY&&`--bg-url: url('${a.imageSrc}')`)},[p("span",ue,U(a.stateText),1),p("input",N({ref:"input",type:"file",accept:"image/*",class:"image-uploader__input"},e.$attrs,{onChange:t[0]||(t[0]=(...l)=>a.handleFileSelect&&a.handleFileSelect(...l)),onClick:t[1]||(t[1]=(...l)=>a.handleClick&&a.handleClick(...l))}),null,16)],6)])}const pe=M(re,[["render",de],["__scopeId","data-v-239a6d25"],["__file","UiImageUploader.vue"]]),me={name:"UiInputDate",components:{UiInput:k},props:{modelValue:Number,type:{type:String,default:"date",validator:e=>["date","datetime-local","time"].includes(e)},step:{type:[Number,String]}},emits:["update:modelValue"],computed:{value(){if(typeof this.modelValue>"u"||this.modelValue===null)return"";const e=new Date(this.modelValue).toISOString();return this.type==="date"?e.substring(0,10):this.type==="datetime-local"?e.substring(0,16):this.type==="time"?this.step&&this.step%60!==0?e.substring(11,19):e.substring(11,16):""}},methods:{handleInput(e){this.$emit("update:modelValue",e.target.value!==""?e.target.valueAsNumber:null)}}};function ce(e,t,n,u,o,a){const l=g("UiInput");return m(),A(l,{"model-value":a.value,type:n.type,onInput:a.handleInput},Y({_:2},[S(Object.keys(e.$slots),d=>({name:d,fn:_(()=>[C(e.$slots,d)])}))]),1032,["model-value","type","onInput"])}const _e=M(me,[["render",ce],["__file","UiInputDate.vue"]]);const ge={name:"UiDropdown",components:{UiIcon:j},props:{modelValue:{},options:{type:Array,required:!0,validator:e=>e.every(t=>typeof t=="object"&&t!==null&&"value"in t&&"text"in t)},title:{type:String,required:!0}},emits:["update:modelValue"],data(){return{isOpen:!1}},computed:{selected(){return this.options.find(e=>e.value===this.modelValue)},hasIcons(){return this.options.some(e=>e.icon)},selectModel:{get(){return this.modelValue},set(e){this.select(e)}}},methods:{toggleOpen(){this.isOpen=!this.isOpen},select(e){this.isOpen=!1,this.$emit("update:modelValue",e)}}},fe={class:"dropdown__menu",role:"listbox"},he=["onClick"],Ie=["value"];function ve(e,t,n,u,o,a){var d,h;const l=g("UiIcon");return m(),I("div",{class:V(["dropdown",{dropdown_opened:o.isOpen}])},[p("button",{type:"button",class:V(["dropdown__toggle",{dropdown__toggle_icon:a.hasIcons}]),onClick:t[0]||(t[0]=(...i)=>a.toggleOpen&&a.toggleOpen(...i))},[(d=a.selected)!=null&&d.icon?(m(),A(l,{key:0,icon:a.selected.icon,class:"dropdown__icon"},null,8,["icon"])):O("",!0),p("span",null,U(((h=a.selected)==null?void 0:h.text)??n.title),1)],2),T(p("div",fe,[(m(!0),I(D,null,S(n.options,i=>(m(),I("button",{key:i.value,class:V(["dropdown__item",{dropdown__item_icon:a.hasIcons}]),role:"option",type:"button",onClick:()=>a.select(i.value)},[i.icon?(m(),A(l,{key:0,icon:i.icon,class:"dropdown__icon"},null,8,["icon"])):O("",!0),F(" "+U(i.text),1)],10,he))),128))],512),[[z,o.isOpen]]),T(p("select",{"onUpdate:modelValue":t[1]||(t[1]=i=>a.selectModel=i),style:{display:"none"}},[(m(!0),I(D,null,S(n.options,i=>(m(),I("option",{key:i.value,value:i.value},U(i.text),9,Ie))),128))],512),[[X,a.selectModel]])],2)}const be=M(ge,[["render",ve],["__scopeId","data-v-da89b199"],["__file","UiDropdown.vue"]]);const y={title:{label:"Нестандартный текст (необязательно)",component:"ui-input",props:{name:"title"}}},P={registration:y,opening:y,talk:{title:{label:"Тема",component:"ui-input",props:{name:"title"}},speaker:{label:"Докладчик",component:"ui-input",props:{name:"speaker"}},description:{label:"Описание",component:"ui-input",props:{multiline:!0,name:"description"}},language:{label:"Язык",component:"ui-dropdown",props:{options:ee,title:"Язык",name:"language"}}},break:y,coffee:y,closing:y,afterparty:y,other:{title:{label:"Заголовок",component:"ui-input",props:{name:"title"}},description:{label:"Описание",component:"ui-input",props:{multiline:!0,name:"description"}}}},ye={name:"MeetupAgendaItemForm",components:{UiIcon:j,UiFormGroup:R,UiInput:k,UiDropdown:be},agendaItemOptions:x,agendaItemFormSchemas:P,props:{agendaItem:{type:Object,required:!0}},emits:["update:agendaItem","remove"],data(){return{localAgendaItem:{...this.agendaItem}}},computed:{startsAt(){return this.localAgendaItem.startsAt},schema(){return P[this.localAgendaItem.type]}},watch:{localAgendaItem:{deep:!0,handler(){this.$emit("update:agendaItem",{...this.localAgendaItem})}},startsAt(e,t){if(!/([0-1]\d|2[0-3]):[0-5]\d/.test(e))return;const n=c=>{const[b,s]=c.split(":").map(w=>parseInt(w,10));return b*60+s},u=n(e),o=n(t),a=n(this.localAgendaItem.endsAt),l=u-o,d=(a+l+24*60)%(24*60),h=Math.floor(d/60).toString().padStart(2,"0"),i=Math.floor(d%60).toString().padStart(2,"0");this.localAgendaItem.endsAt=`${h}:${i}`}}},Ue={class:"agenda-item-form"},Ae={class:"agenda-item-form__row"},Me={class:"agenda-item-form__col"},we={class:"agenda-item-form__col"};function Se(e,t,n,u,o,a){const l=g("UiIcon"),d=g("UiDropdown"),h=g("UiFormGroup"),i=g("UiInput");return m(),I("fieldset",Ue,[p("button",{type:"button",class:"agenda-item-form__remove-button",onClick:t[0]||(t[0]=c=>e.$emit("remove"))},[r(l,{icon:"trash"})]),r(h,null,{default:_(()=>[r(d,{modelValue:o.localAgendaItem.type,"onUpdate:modelValue":t[1]||(t[1]=c=>o.localAgendaItem.type=c),title:"Тип",options:e.$options.agendaItemOptions,name:"type"},null,8,["modelValue","options"])]),_:1}),p("div",Ae,[p("div",Me,[r(h,{label:"Начало"},{default:_(()=>[r(i,{modelValue:o.localAgendaItem.startsAt,"onUpdate:modelValue":t[2]||(t[2]=c=>o.localAgendaItem.startsAt=c),type:"time",placeholder:"00:00",name:"startsAt"},null,8,["modelValue"])]),_:1})]),p("div",we,[r(h,{label:"Окончание"},{default:_(()=>[r(i,{modelValue:o.localAgendaItem.endsAt,"onUpdate:modelValue":t[3]||(t[3]=c=>o.localAgendaItem.endsAt=c),type:"time",placeholder:"00:00",name:"endsAt"},null,8,["modelValue"])]),_:1})])]),(m(!0),I(D,null,S(a.schema,(c,b)=>(m(),A(h,{key:b,label:c.label},{default:_(()=>[(m(),A(Z(c.component),N({modelValue:o.localAgendaItem[b],"onUpdate:modelValue":s=>o.localAgendaItem[b]=s},c.props),null,16,["modelValue","onUpdate:modelValue"]))]),_:2},1032,["label"]))),128))])}const Ve=M(ye,[["render",Se],["__scopeId","data-v-5d674c51"],["__file","MeetupAgendaItemForm.vue"]]);const Fe={name:"MeetupForm",components:{MeetupAgendaItemForm:Ve,UiButton:W,UiFormGroup:R,UiImageUploader:pe,UiInput:k,UiInputDate:_e},props:{meetup:{type:Object,required:!0},submitText:{type:String,default:""}},emits:["submit","cancel"],data(){return{localMeetup:v(this.meetup)}},methods:{addAgendaItem(){const e=te();this.localMeetup.agenda.length&&(e.startsAt=this.localMeetup.agenda[this.localMeetup.agenda.length-1].endsAt),this.localMeetup.agenda.push(e)},removeAgendaItem(e){this.localMeetup.agenda.splice(e,1)},handleSubmit(){this.$emit("submit",v(this.localMeetup))}}},De=e=>(J("data-v-5c001602"),e=e(),K(),e),ke={class:"meetup-form__content"},Le={class:"meetup-form__section"},Oe=De(()=>p("h3",{class:"meetup-form__agenda-title"},"Программа",-1)),Te={class:"meetup-form__append"},Ee={class:"meetup-form__aside"},Pe={class:"meetup-form__aside-stick"};function je(e,t,n,u,o,a){const l=g("UiInput"),d=g("UiFormGroup"),h=g("UiInputDate"),i=g("UiImageUploader"),c=g("MeetupAgendaItemForm"),b=g("UiButton");return m(),I("form",{class:"meetup-form",onSubmit:t[8]||(t[8]=H((...s)=>a.handleSubmit&&a.handleSubmit(...s),["prevent"]))},[p("div",ke,[p("fieldset",Le,[r(d,{label:"Название"},{default:_(()=>[r(l,{modelValue:o.localMeetup.title,"onUpdate:modelValue":t[0]||(t[0]=s=>o.localMeetup.title=s),name:"title"},null,8,["modelValue"])]),_:1}),r(d,{label:"Дата"},{default:_(()=>[r(h,{modelValue:o.localMeetup.date,"onUpdate:modelValue":t[1]||(t[1]=s=>o.localMeetup.date=s),type:"date",name:"date"},null,8,["modelValue"])]),_:1}),r(d,{label:"Место"},{default:_(()=>[r(l,{modelValue:o.localMeetup.place,"onUpdate:modelValue":t[2]||(t[2]=s=>o.localMeetup.place=s),name:"place"},null,8,["modelValue"])]),_:1}),r(d,{label:"Описание"},{default:_(()=>[r(l,{modelValue:o.localMeetup.description,"onUpdate:modelValue":t[3]||(t[3]=s=>o.localMeetup.description=s),multiline:"",rows:"3",name:"description"},null,8,["modelValue"])]),_:1}),r(d,{label:"Изображение"},{default:_(()=>[r(i,{name:"image",preview:o.localMeetup.image,onSelect:t[4]||(t[4]=s=>o.localMeetup.imageToUpload=s),onRemove:t[5]||(t[5]=s=>o.localMeetup.imageId=o.localMeetup.imageToUpload=null)},null,8,["preview"])]),_:1})]),Oe,(m(!0),I(D,null,S(o.localMeetup.agenda,(s,w)=>(m(),A(c,{key:s.id,"agenda-item":o.localMeetup.agenda[w],"onUpdate:agenda-item":L=>o.localMeetup.agenda[w]=L,class:"meetup-form__agenda-item",onRemove:L=>a.removeAgendaItem(w)},null,8,["agenda-item","onUpdate:agenda-item","onRemove"]))),128)),p("div",Te,[p("button",{class:"meetup-form__append-button",type:"button","data-test":"addAgendaItem",onClick:t[6]||(t[6]=(...s)=>a.addAgendaItem&&a.addAgendaItem(...s))}," + Добавить этап программы ")])]),p("div",Ee,[p("div",Pe,[r(b,{class:"meetup-form__aside-button",block:"","data-test":"cancel",variant:"secondary",onClick:t[7]||(t[7]=s=>e.$emit("cancel"))},{default:_(()=>[F(" Отмена ")]),_:1}),r(b,{variant:"primary",block:"",class:"meetup-form__aside-button",type:"submit","data-test":"submit"},{default:_(()=>[F(U(n.submitText),1)]),_:1})])])],32)}const Ze=M(Fe,[["render",je],["__scopeId","data-v-5c001602"],["__file","MeetupForm.vue"]]);function Ce(e){const t=new FormData;return t.append("file",e),$.post("/images/upload",t)}function He(e){const t=Q(),{request:n}=E(e==="create"?oe:ne,{showProgress:!0,successToast:"Сохранено",errorToast:!0}),{request:u}=E(Ce,{showProgress:!0,errorToast:!0});return async o=>{if(o.imageToUpload){const l=await u(o.imageToUpload);if(!l.success)return;o.imageId=l.data.id,delete o.imageToUpload}const a=await n(o);a.success&&t.push({name:"meetup",params:{meetupId:a.data.id}})}}export{Xe as L,Ze as M,He as u};
